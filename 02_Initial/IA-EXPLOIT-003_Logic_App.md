# [IA-EXPLOIT-003]: Logic App HTTP Trigger Abuse

## Metadata
| Attribute | Details |
|---|---|
| **Technique ID** | IA-EXPLOIT-003 |
| **MITRE ATT&CK v18.1** | [Exploit Public-Facing Application (T1190)](https://attack.mitre.org/techniques/T1190/) |
| **Tactic** | Initial Access |
| **Platforms** | Entra ID / Azure Resources |
| **Severity** | **High** |
| **Author** | SERVTEP (Pchelnikau Artur) |

## 2. EXECUTIVE SUMMARY
- **Concept:** Logic Apps with "HTTP Request" triggers generate a publicly accessible URL containing a Shared Access Signature (SAS) in the query string (`?sig=...`). If this URL is leaked (e.g., in client-side JavaScript, GitHub repos, or intercepted traffic), anyone can trigger the workflow.
- **Attack Surface:** Exposed SAS URLs.
- **Business Impact:** **Execution of Arbitrary Logic**. Depending on what the Logic App does (e.g., "Create User", "Copy Blob", "Send Email"), the attacker can perform unauthorized actions or pivot further.

## 3. PREREQUISITES & CONFIGURATION
- **Vulnerable Config:** Logic App HTTP Trigger configured with default SAS security (no IP whitelist, no OAuth/Entra ID Auth).
- **Tools:**
    - Browser DevTools (to find the URL)
    - `curl` / Postman

## 4. ATTACK (Red Team Operations)

#### 4.1 Usage
**Step 1: Discovery**
Find the SAS URL. This is often hardcoded in the `main.js` of Single Page Apps (SPAs) or mobile apps that call the backend directly.

`https://prod-00.westus.logic.azure.com:443/workflows/{ID}/triggers/manual/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig={SIGNATURE}`

**Step 2: Exploitation**
Replay the request with a malicious payload. If the Logic App takes input parameters (e.g., email address) and processes them without validation, injection might be possible.

```bash
# Basic Trigger
curl -X POST -H "Content-Type: application/json" -d '{"email": "attacker@evil.com", "cmd": "whoami"}' [Found_URL]
```

## 5. DETECTION (Blue Team Operations)

#### 5.1 Azure Activity Log / Logic App Runs
Monitor `Microsoft.Logic/workflows/triggers/run/action`.
*   **Logic:** Look for source IPs outside known corporate ranges triggering the workflow.

#### 5.2 Sentinel (KQL)
```kusto
AzureDiagnostics
| where ResourceProvider == "MICROSOFT.LOGIC"
| where Category == "WorkflowRuntime"
| where OperationName == "Microsoft.Logic/workflows/workflowTriggerHistories/write"
| extend Status = tostring(parse_json(properties_s).status)
| where Status == "Succeeded"
// Join with caller IP info if available (requires diagnostic settings to be verbose)
| project TimeGenerated, Resource, Status
```

## 6. DEFENSE & REMEDIATION (Hardening)

#### 6.2 Immediate Remediation
*   **Network:** Configure **Access Control Ranges** (IP Whitelisting) in the Trigger settings. Only allow calls from trusted IPs (e.g., API Management, Corporate VPN).
*   **Auth:** **Regenerate Access Keys** immediately if a leak is suspected.
*   **Architecture:** Deprecate SAS triggers for public-facing apps. Use **Azure API Management (APIM)** in front of the Logic App to enforce Entra ID authentication (OAuth) before the request reaches the Logic App.

## 7. ATTACK CHAIN
> **Preceding Technique:** [REC-CLOUD-005] (Enumerating Azure Resources)
> **Next Logical Step:** [LAT-CLOUD-001] (Pivoting to other Azure resources via Managed Identity)
