# [PE-EXPLOIT-005]: Pod Security Context Escalation

## Metadata
| Attribute | Details |
|---|---|
| **Technique ID** | PE-EXPLOIT-005 |
| **MITRE ATT&CK v18.1** | [Exploitation for Privilege Escalation (T1068)](https://attack.mitre.org/techniques/T1068/) |
| **Tactic** | Privilege Escalation |
| **Platforms** | Kubernetes / AKS |
| **Severity** | **Medium** |
| **Author** | SERVTEP (Pchelnikau Artur) |

## 2. EXECUTIVE SUMMARY
- **Concept:** Even without full `privileged` mode, specific capabilities in the Pod Security Context (`securityContext`) can be abused. For example, `CAP_SYS_ADMIN` allows mounting cgroups, `CAP_SYS_PTRACE` allows debugging other processes, and `CAP_DAC_READ_SEARCH` allows reading file handles from the host. An attacker who compromises a pod with these capabilities can pivot to the host.
- **Attack Surface:** Pod Manifest (`capabilities.add`).
- **Business Impact:** **Node Compromise**.

## 3. PREREQUISITES & CONFIGURATION
- **Required Privileges:** Root inside a Pod with capabilities.
- **Tools:**
    - Custom C Exploits (Shocker, release_agent)

## 4. ATTACK (Red Team Operations)

#### 4.1 Usage
**Step 1: Check Capabilities**
```bash
grep CapEff /proc/self/status
# Decode the bitmap (e.g., using capsh --decode)
```

**Step 2: Exploit (release_agent)**
If `CAP_SYS_ADMIN` is present:
1. Mount cgroup v1 controller.
2. Enable `notify_on_release`.
3. Set `release_agent` to a script on the mounted host filesystem.
4. Trigger release (terminate a process).
*Host executes the script as Root.*

## 5. DETECTION (Blue Team Operations)

#### 5.1 Host Logs
| Source | Event | Filter Logic |
|---|---|---|
| **Auditd** | `Syscall` | Creation of cgroups or modification of `release_agent` files. |

## 6. DEFENSE & REMEDIATION (Hardening)

#### 6.2 Immediate Remediation
*   **Drop Capabilities:** Explicitly set `capabilities: drop: ["ALL"]` in Pod specs. Only add back what is strictly needed (e.g., `NET_BIND_SERVICE`).

## 7. ATTACK CHAIN
> **Preceding Technique:** [IA-CLOUD-003]
> **Next Logical Step:** [PE-EXPLOIT-004]
